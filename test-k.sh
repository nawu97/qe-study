#!/bin/sh
#SBATCH --job-name=qe-test
#SBATCH -N 1
##SBATCH --ntasks-per-node=52
##SBATCH --time=3-00:00:00
#SBATCH -p regular

for k in 1 3 5 7 9 11
do
    echo "Running for k-mesh = $k ..."

    #self-consistent calculation
    cat > pw.NV.relaxed-test-k.in << EOF
&CONTROL
 calculation='scf',
 restart_mode='from_scratch',
 prefix='NV-center_relax',
 pseudo_dir='./pseudo',
 outdir='./tmp',
 forc_conv_thr=1.0d-5
/
&SYSTEM
  ibrav = 0
  A =    7.1096183338
  nat = 63
  ntyp = 2
   occupations = 'smearing', 
  smearing='gauss', 
  degauss=1.0d-9,
  ecutwfc = 100
/
&ELECTRONS
   conv_thr=1.0d-8
/
&IONS
   ion_dynamics='bfgs'
/
&CELL
   cell_dynamics='bfgs',
   press=0.0d0,
   press_conv_thr=0.5d0
/
CELL_PARAMETERS {alat}
   1.007331527  -0.003397712   0.003397712
  -0.003397712   1.007331527  -0.003397712
   0.003397712  -0.003397712   1.007331527
ATOMIC_SPECIES
   N   14.00650   N.pbe-n-kjpaw_psl.1.0.0.UPF
   C   12.01060   C.pbe-n-kjpaw_psl.1.0.0.UPF
ATOMIC_POSITIONS {crystal}
N             0.3704637974        0.6295362026        0.3704637974
C            -0.0000789557        0.0000789557       -0.0000789557
C            -0.0001468590        0.2503112562        0.2498285635
C             0.2502247983       -0.0001064291        0.2502247983
C             0.2498285635        0.2503112562       -0.0001468590
C             0.3747822268        0.1246655577        0.3747822268
C             0.1250301660        0.1248686756        0.1250301660
C             0.1255573705        0.3754522277        0.3755986840
C             0.3755986840        0.3754522277        0.1255573705
C             0.4995609321        0.0000517970       -0.0000517970
C             0.4986923137        0.2528268937        0.2529044533
C             0.7496887438        0.0001468590        0.2498285635
C             0.7497734592        0.2502265408        0.0001295890
C             0.8754409634        0.1245590366        0.3747670722
C             0.6260575624        0.1246716011        0.1246872332
C             0.6303499504        0.3696500496        0.3735189087
C             0.8753283989        0.3739424376        0.1246872332
C            -0.0000517970        0.5004390679       -0.0000517970
C             0.0001064291        0.7497752017        0.2502247983
C             0.2511668857        0.5025385167        0.2511668857
C             0.2502247983        0.7497752017        0.0001064291
C             0.1248674115        0.6248746720        0.1248674115
C             0.1248674115        0.8751325885        0.3751253280
C             0.3751253280        0.8751325885        0.1248674115
C             0.5000235461        0.4999764539       -0.0001946080
C             0.4974614833        0.7488331143        0.2511668857
C             0.7471731063        0.5013076863        0.2529044533
C             0.7496887438        0.7501714365       -0.0001468590
C             0.8753344423        0.6252177732        0.3747822268
C             0.6245477723        0.6244013160        0.1255573705
C             0.6245477723        0.8744426295        0.3755986840
C             0.8751313244        0.8749698340        0.1250301660
C            -0.0000517970        0.0000517970        0.4995609321
C             0.0001295890        0.2502265408        0.7497734592
C             0.2498285635        0.0001468590        0.7496887438
C             0.2529044533        0.2528268937        0.4986923137
C             0.3747670722        0.1245590366        0.8754409634
C             0.1246872332        0.1246716011        0.6260575624
C             0.1246872332        0.3739424376        0.8753283989
C             0.3735189087        0.3696500496        0.6303499504
C             0.5000235461        0.0001946080        0.5000235461
C             0.4998876846        0.2524052546        0.7475947454
C             0.7497734592       -0.0001295890        0.7497734592
C             0.7475947454        0.2524052546        0.4998876846
C             0.8750785043        0.1249214957        0.8750785043
C             0.6250946709        0.1247206711        0.6250946709
C             0.6250946709        0.3749053291        0.8752793289
C             0.8752793289        0.3749053291        0.6250946709
C            -0.0001946080        0.4999764539        0.5000235461
C            -0.0001468590        0.7501714365        0.7496887438
C             0.2529044533        0.5013076863        0.7471731063
C             0.2511668857        0.7488331143        0.4974614833
C             0.3747822268        0.6252177732        0.8753344423
C             0.1255573705        0.6244013160        0.6245477723
C             0.1250301660        0.8749698340        0.8751313244
C             0.3755986840        0.8744426295        0.6245477723
C             0.4986923137        0.7470955467        0.7471731063
C             0.7475947454        0.5001123154        0.7475947454
C             0.7471731063        0.7470955467        0.4986923137
C             0.8754409634        0.6252329278        0.8754409634
C             0.6303499504        0.6264810913        0.6303499504
C             0.6260575624        0.8753127668        0.8753283989
C             0.8753283989        0.8753127668        0.6260575624
K_POINTS {automatic}
$k $k $k 0 0 0
EOF
    # run the pw.x calculation
	ulimit -s unlimited
	ulimit -c unlimited
	#module load pmix/2.2.2
	module load parallel_studio/2020.2.254
	module load intelmpi/2020.2.254
	EXEC=/home/users/nawu/qe/TDPW6.6/pw.x
	srun --mpi=pmi2   $EXEC -i  pw.NV.relaxed-test-k.in | tee pw.NV.relaxed-test-k.out


    # collect the k-mesh and total-energy from the pw.si.scf.out output-file
       E=`grep -e '!' pw.NV.relaxed-test-k.out|tail -1|awk '{printf "%12.6f\n" ,$5}'`
       echo $k $E >> NV.test-k
done

